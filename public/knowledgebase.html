<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Knowledge Base</title>
  <link rel="stylesheet" href="dashboard.css" />
  <style>
    .kb-search { margin-bottom: 1em; }
    .kb-entry { border: 1px solid #ccc; border-radius: 10px; padding: 15px; margin-bottom: 15px; }
    .kb-entry h3 { margin: 0 0 5px; }
    .kb-entry p { margin: 5px 0; }
    .solution { background: #f5f5f5; padding: 10px; border-left: 5px solid #4CAF50; }
  </style>
</head>
<body>
  <div class="dashboard">
    <aside class="sidebar">
      <h2>Help Desk</h2>
      <ul>
      <li><a id="nav-tickets" class="nav-link"><span>üìã</span> Tickets</a></li>
      <li><a href="templates.html" class="nav-link" id="nav-templates"><span>üìÑ</span> Templates</a></li>
      <li><a class="nav-link active" id="nav-kb"><span>üìö</span> Knowledgebase</a></li>
      <li><a href="categories.html" class="nav-link" id="nav-categories"><span>üìÇ</span> Categories</a></li>
<li id="nav-team-li"><a href="team.html" class="nav-link" id="nav-team"><span>üë•</span> Team</a></li>            
      <li><a href="reports.html" class="nav-link" id="nav-reports"><span>üìä</span> Reports</a></li>
      <li><a href="tools.html" class="nav-link" id="nav-tools"><span>üîß</span> Tools</a></li>
      <li><a href="settings.html" class="nav-link" id="nav-settings"><span>‚öôÔ∏è</span> Settings</a></li>
      <!-- Users link will be injected by JS for admins -->
    </ul>
    </aside>

    <main class="main-content">
      <header class="dashboard-header">
        <h1>Knowledge Base</h1>
      </header>

      <div class="kb-search">
        <input type="text" id="searchBox" placeholder="Search problems or keywords..." style="width: 100%; padding: 8px;" />
      </div>

      <div id="kbContainer"></div>
      <!-- Only visible to Admins -->
<section id="kbAdminControls" style="display: none; margin-top: 30px;">
  <h2>‚ûï Add New Article</h2>
  <form id="kbForm">
    <input type="text" id="kbTitle" placeholder="Title" required style="width: 100%; padding: 8px; margin-bottom: 8px;" />
    <input type="text" id="kbCategory" placeholder="Category" required style="width: 100%; padding: 8px; margin-bottom: 8px;" />
    <textarea id="kbProblem" placeholder="Problem Description" required style="width: 100%; padding: 8px; margin-bottom: 8px;"></textarea>
    <textarea id="kbSolution" placeholder="Solution Description" required style="width: 100%; padding: 8px; margin-bottom: 8px;"></textarea>
    <button type="submit">Create Article</button>
  </form>
</section>

    </main>
  </div>

  <script>
    let allArticles = [];

    window.addEventListener("DOMContentLoaded", async () => {
      try {
        const response = await fetch('/api/me', { credentials: 'include' });
      if (!response.ok) throw new Error("User not authenticated");

      const user = await response.json();
      window.currentUser = user;
      window.isAdmin = user.role_id === 1;
const navTeamLi = document.getElementById("nav-team-li");
      const navTickets = document.getElementById('nav-tickets');
      if (user.role_id === 1) {
        navTickets.href = 'admin_dashboard.html';
        navTeamLi.style.display = "list-item";
        document.getElementById("kbAdminControls").style.display = "block";
        // Inject Users link if admin
        const usersLi = document.createElement('li');
        usersLi.innerHTML = '<a href="admin_users.html" class="nav-link" id="nav-users"><span>üë§</span> Users</a>';
        document.querySelector('.sidebar ul').appendChild(usersLi);
      } else if (user.role_id === 2) {
        navTickets.href = 'agent_dashboard.html';
        navTeamLi.style.display = "list-item";
      } else {
        navTickets.href = 'customer_dashboard.html';
        navTeamLi.style.display = "none";
      }
      // Set Tools link based on role (always run this after user info is fetched)
      const navTools = document.getElementById('nav-tools');
      if (user.role_id === 1) navTools.href = 'admin_tools.html';
      else if (user.role_id === 2) navTools.href = 'agent_tools.html';
      else navTools.href = 'customer_tools.html';
      } catch (err) {
      console.error("üîí Could not fetch user info, please login again", err);
      // Optional: redirect to login
      window.location.href = 'signin.html';
    }
    try{
        const res = await fetch("http://localhost:3000/api/knowledgebase");
        if (!res.ok) throw new Error("Failed to fetch knowledge base");
        allArticles = await res.json();
        renderKB(allArticles);
      } catch (err) {
        console.error(err);
        document.getElementById("kbContainer").innerText = "Unable to load knowledge base.";
      }

      document.getElementById("searchBox").addEventListener("input", e => {
        const keyword = e.target.value.toLowerCase();
        const filtered = allArticles.filter(article =>
          article.TITLE.toLowerCase().includes(keyword) ||
          article.PROBLEM_DESC.toLowerCase().includes(keyword) ||
          article.SOLUTION_DESC.toLowerCase().includes(keyword)
        );
        renderKB(filtered);
      });
    });

    function renderKB(articles) {
      const container = document.getElementById("kbContainer");
      container.innerHTML = "";

      if (articles.length === 0) {
        container.innerHTML = "<p>No matching articles found.</p>";
        return;
      }

      articles.forEach(article => {
        const entry = document.createElement("div");
        entry.className = "kb-entry";
        entry.dataset.id = article.ID;

        entry.innerHTML = `
          <h3>${article.TITLE}</h3>
          <p><strong>Category:</strong> ${article.CATEGORY}</p>
          <p>${article.PROBLEM_DESC}</p>
          <div class="solution"><strong>Solution:</strong><br>${article.SOLUTION_DESC}</div>
          ${window.isAdmin ? `<button class="edit-btn">‚úèÔ∏è Edit</button>
          <button class="delete-btn" data-id="${article.ID}" style="margin-top:10px;color:red;">üóëÔ∏è Delete</button>` : ""}
          `;

        container.appendChild(entry);
      });
        if (window.isAdmin) {
    document.querySelectorAll(".edit-btn").forEach(btn => {
      btn.addEventListener("click", handleEditClick);
    });
    document.querySelectorAll(".delete-btn").forEach(button => {
      button.addEventListener("click", async (e) => {
        const id = e.target.dataset.id;
        if (!confirm("Are you sure you want to delete this article?")) return;
        try {
          const res = await fetch(`/api/knowledgebase/${id}`, {
            method: "DELETE"
          });
          const data = await res.json();
          if (res.ok) {
            alert("‚úÖ Article deleted!");
            location.reload();
          } else {
            alert("‚ùå " + data.error);
          }
        } catch (err) {
          console.error("‚ùå Error deleting:", err);
          alert("Error deleting article.");
        }
  });});}}
  let currentEditId = null;

function handleEditClick(e) {
  const kbEntry = e.target.closest(".kb-entry");
  currentEditId = kbEntry.dataset.id;

  const title = kbEntry.querySelector("h3").innerText;
  const problem = kbEntry.querySelector("p:nth-of-type(2)").innerText;
  const solution = kbEntry.querySelector(".solution").innerHTML.replace(/<[^>]+>/g, '').replace("Solution:", '').trim();

  document.getElementById("editTitle").value = title;
  document.getElementById("editProblem").value = problem;
  document.getElementById("editSolution").value = solution;

  document.getElementById("editModal").style.display = "block";
}

async function saveEdit() {
  const title = document.getElementById("editTitle").value;
  const problem = document.getElementById("editProblem").value;
  const solution = document.getElementById("editSolution").value;

  try {
    const res = await fetch(`/api/knowledgebase/${currentEditId}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      credentials: 'include',
      body: JSON.stringify({
        title,
        problem_desc: problem,
        solution_desc: solution
      })
    });

    if (!res.ok) throw new Error("Update failed");
    alert("‚úÖ KB updated!");
    document.getElementById("editModal").style.display = "none";
    location.reload(); // refresh updated KB
  } catch (err) {
    alert("‚ùå Failed to update KB: " + err.message);
  }
}

  </script>
  <!-- Modal-style edit form -->
<div id="editModal" style="display:none; position:fixed; top:10%; left:50%; transform:translateX(-50%);
  background:#fff; border:1px solid #ccc; padding:20px; border-radius:10px; z-index:1000; max-width:500px;">
  <h3>Edit Knowledge Base Entry</h3>
  <input type="text" id="editTitle" placeholder="Title" style="width:100%; margin-bottom:10px;" />
  <textarea id="editProblem" placeholder="Problem Description" style="width:100%; height:60px; margin-bottom:10px;"></textarea>
  <textarea id="editSolution" placeholder="Solution Description" style="width:100%; height:60px;"></textarea>
  <br/>
  <button onclick="saveEdit()">üíæ Save</button>
  <button onclick="document.getElementById('editModal').style.display='none'">‚ùå Cancel</button>
</div>
</body>
</html>
