<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Helpdesk | Admin Settings</title>
  <link rel="stylesheet" href="dashboard.css" />
  <style>
    .settings-tabs { display: flex; gap: 16px; margin-bottom: 24px; }
    .settings-tab { cursor: pointer; padding: 10px 18px; border-radius: 8px 8px 0 0; background: #f3f6fa; color: #2a7ae2; font-weight: 500; }
    .settings-tab.active { background: #fff; border-bottom: 2px solid #2a7ae2; color: #233044; }
    .settings-section { display: none; }
    .settings-section.active { display: block; }
    .settings-table th, .settings-table td { padding: 10px; text-align: left; }
    .settings-table { width: 100%; background: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-collapse: collapse; margin-bottom: 24px; }
    .settings-table th { background: #f3f6fa; }
    .settings-table tr:not(:last-child) { border-bottom: 1px solid #eee; }
    .settings-form { display: flex; gap: 12px; margin-top: 12px; flex-wrap: wrap; }
    .settings-form input, .settings-form select { padding: 8px; border-radius: 6px; border: 1px solid #ccc; }
    .settings-form button { background: #2a7ae2; color: #fff; border: none; border-radius: 6px; padding: 8px 16px; cursor: pointer; }
    .settings-form button:hover { background: #1d5cb0; }
    .action-btn { background: #eee; border: none; border-radius: 6px; padding: 6px 12px; margin-right: 6px; cursor: pointer; }
    .action-btn.edit { color: #2a7ae2; }
    .action-btn.delete { color: #e74c3c; }
  </style>
</head>
<body>
  <div class="dashboard">
    <aside class="sidebar">
      <h2>Help Desk</h2>
      <ul>
        <li><a href="admin_dashboard.html" class="nav-link"><span>üìã</span> Tickets</a></li>
        <li><a href="templates.html" class="nav-link"><span>üìÑ</span> Templates</a></li>
        <li><a href="knowledgebase.html" class="nav-link"><span>üìö</span> Knowledgebase</a></li>
        <li><a href="categories.html" class="nav-link"><span>üìÇ</span> Categories</a></li>
        <li><a href="team.html" class="nav-link"><span>üë•</span> Team</a></li>
        <li><a href="reports.html" class="nav-link"><span>üìä</span> Reports</a></li>
        <li><a href="admin_tools.html" class="nav-link" id="nav-tools"><span>üîß</span> Tools</a></li>
        <li><a class="nav-link active" id="nav-settings"><span>‚öôÔ∏è</span> Settings</a></li>
        <li><a href="admin_users.html" class="nav-link" id="nav-users"><span>üë§</span> Users</a></li>
      </ul>
    </aside>
    <main class="main-content">
      <header class="dashboard-header">
        <h1>Admin Settings</h1>
      </header>
      <div class="settings-tabs">
        <div class="settings-tab active" data-tab="categories">Categories</div>
        <div class="settings-tab" data-tab="subcategories">Subcategories</div>
        <div class="settings-tab" data-tab="sla">SLA Levels</div>
        <div class="settings-tab" data-tab="roles">Roles</div>
      </div>
      <div id="categories-section" class="settings-section active">
        <h2>Categories</h2>
        <table class="settings-table" id="categoriesTable">
          <thead><tr><th>Name</th><th>Description</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>
        <form class="settings-form" id="addCategoryForm">
          <input type="text" id="categoryName" placeholder="Name" required />
          <input type="text" id="categoryDesc" placeholder="Description" />
          <button type="submit">Add Category</button>
        </form>
      </div>
      <div id="subcategories-section" class="settings-section">
        <h2>Subcategories</h2>
        <table class="settings-table" id="subcategoriesTable">
          <thead><tr><th>Category</th><th>Name</th><th>Description</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>
        <form class="settings-form" id="addSubcategoryForm">
          <select id="subcategoryCategory" required></select>
          <input type="text" id="subcategoryName" placeholder="Name" required />
          <input type="text" id="subcategoryDesc" placeholder="Description" />
          <button type="submit">Add Subcategory</button>
        </form>
      </div>
      <div id="sla-section" class="settings-section">
        <h2>SLA Levels</h2>
        <table class="settings-table" id="slaTable">
          <thead><tr><th>Name</th><th>Description</th><th>Response Time (h)</th><th>Resolution Time (h)</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>
        <form class="settings-form" id="addSlaForm">
          <input type="text" id="slaName" placeholder="Name" required />
          <input type="text" id="slaDesc" placeholder="Description" />
          <input type="number" id="slaResponse" placeholder="Response Time (h)" required min="0" />
          <input type="number" id="slaResolution" placeholder="Resolution Time (h)" required min="0" />
          <button type="submit">Add SLA Level</button>
        </form>
      </div>
      <div id="roles-section" class="settings-section">
        <h2>Roles</h2>
        <table class="settings-table" id="rolesTable">
          <thead><tr><th>Name</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>
        <form class="settings-form" id="addRoleForm">
          <input type="text" id="roleName" placeholder="Role Name" required />
          <button type="submit">Add Role</button>
        </form>
      </div>
    </main>
  </div>
  <script>
    // Tab switching
    document.querySelectorAll('.settings-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.settings-section').forEach(s => s.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab + '-section').classList.add('active');
      });
    });

    // --- CATEGORIES CRUD ---
    async function loadCategories() {
      const tbody = document.querySelector('#categoriesTable tbody');
      tbody.innerHTML = '<tr><td colspan="3">Loading...</td></tr>';
      try {
        const res = await fetch('/api/settings/categories', { credentials: 'include' });
        const cats = await res.json();
        tbody.innerHTML = '';
        cats.forEach(cat => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><input type="text" value="${cat.NAME}" data-id="${cat.CATEGORY_ID}" class="edit-cat-name" style="border:none;background:transparent;width:100%" readonly /></td>
            <td><input type="text" value="${cat.DESCRIPTION || ''}" data-id="${cat.CATEGORY_ID}" class="edit-cat-desc" style="border:none;background:transparent;width:100%" readonly /></td>
            <td>
              <button class="action-btn edit" data-id="${cat.CATEGORY_ID}">Edit</button>
              <button class="action-btn delete" data-id="${cat.CATEGORY_ID}">Delete</button>
            </td>`;
          tbody.appendChild(tr);
        });
        // Edit
        tbody.querySelectorAll('.edit').forEach(btn => {
          btn.onclick = e => {
            const id = btn.dataset.id;
            const nameInput = tbody.querySelector(`.edit-cat-name[data-id='${id}']`);
            const descInput = tbody.querySelector(`.edit-cat-desc[data-id='${id}']`);
            nameInput.readOnly = descInput.readOnly = false;
            nameInput.style.background = descInput.style.background = '#f9f9f9';
            btn.textContent = 'Save';
            btn.classList.remove('edit');
            btn.classList.add('save');
            btn.onclick = async () => {
              await fetch(`/api/settings/categories/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ name: nameInput.value, description: descInput.value })
              });
              loadCategories();
            };
          };
        });
        // Delete
        tbody.querySelectorAll('.delete').forEach(btn => {
          btn.onclick = async () => {
            if (confirm('Delete this category?')) {
              await fetch(`/api/settings/categories/${btn.dataset.id}`, { method: 'DELETE', credentials: 'include' });
              loadCategories();
              loadSubcategories(); // update subcat list
            }
          };
        });
      } catch (err) {
        tbody.innerHTML = '<tr><td colspan="3">Failed to load categories</td></tr>';
      }
    }
    document.getElementById('addCategoryForm').onsubmit = async e => {
      e.preventDefault();
      const name = document.getElementById('categoryName').value;
      const desc = document.getElementById('categoryDesc').value;
      await fetch('/api/settings/categories', {
        method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'include',
        body: JSON.stringify({ name, description: desc })
      });
      e.target.reset();
      loadCategories();
      loadSubcategories();
    };

    // --- SUBCATEGORIES CRUD ---
    async function loadSubcategories() {
      const tbody = document.querySelector('#subcategoriesTable tbody');
      const catSelect = document.getElementById('subcategoryCategory');
      tbody.innerHTML = '<tr><td colspan="4">Loading...</td></tr>';
      catSelect.innerHTML = '';
      try {
        const [subRes, catRes] = await Promise.all([
          fetch('/api/settings/subcategories', { credentials: 'include' }),
          fetch('/api/settings/categories', { credentials: 'include' })
        ]);
        const subcats = await subRes.json();
        const cats = await catRes.json();
        // Populate category select
        cats.forEach(cat => {
          const opt = document.createElement('option');
          opt.value = cat.CATEGORY_ID;
          opt.textContent = cat.NAME;
          catSelect.appendChild(opt);
        });
        tbody.innerHTML = '';
        subcats.forEach(sub => {
          const cat = cats.find(c => c.CATEGORY_ID === sub.CATEGORY_ID);
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><select class="edit-sub-cat" data-id="${sub.SUBCATEGORY_ID}" disabled>${cats.map(c => `<option value="${c.CATEGORY_ID}"${c.CATEGORY_ID===sub.CATEGORY_ID?' selected':''}>${c.NAME}</option>`).join('')}</select></td>
            <td><input type="text" value="${sub.NAME}" data-id="${sub.SUBCATEGORY_ID}" class="edit-sub-name" style="border:none;background:transparent;width:100%" readonly /></td>
            <td><input type="text" value="${sub.DESCRIPTION || ''}" data-id="${sub.SUBCATEGORY_ID}" class="edit-sub-desc" style="border:none;background:transparent;width:100%" readonly /></td>
            <td>
              <button class="action-btn edit" data-id="${sub.SUBCATEGORY_ID}">Edit</button>
              <button class="action-btn delete" data-id="${sub.SUBCATEGORY_ID}">Delete</button>
            </td>`;
          tbody.appendChild(tr);
        });
        // Edit
        tbody.querySelectorAll('.edit').forEach(btn => {
          btn.onclick = e => {
            const id = btn.dataset.id;
            const catSel = tbody.querySelector(`.edit-sub-cat[data-id='${id}']`);
            const nameInput = tbody.querySelector(`.edit-sub-name[data-id='${id}']`);
            const descInput = tbody.querySelector(`.edit-sub-desc[data-id='${id}']`);
            catSel.disabled = false;
            nameInput.readOnly = descInput.readOnly = false;
            nameInput.style.background = descInput.style.background = '#f9f9f9';
            btn.textContent = 'Save';
            btn.classList.remove('edit');
            btn.classList.add('save');
            btn.onclick = async () => {
              await fetch(`/api/settings/subcategories/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ category_id: catSel.value, name: nameInput.value, description: descInput.value })
              });
              loadSubcategories();
            };
          };
        });
        // Delete
        tbody.querySelectorAll('.delete').forEach(btn => {
          btn.onclick = async () => {
            if (confirm('Delete this subcategory?')) {
              await fetch(`/api/settings/subcategories/${btn.dataset.id}`, { method: 'DELETE', credentials: 'include' });
              loadSubcategories();
            }
          };
        });
      } catch (err) {
        tbody.innerHTML = '<tr><td colspan="4">Failed to load subcategories</td></tr>';
      }
    }
    document.getElementById('addSubcategoryForm').onsubmit = async e => {
      e.preventDefault();
      const category_id = document.getElementById('subcategoryCategory').value;
      const name = document.getElementById('subcategoryName').value;
      const desc = document.getElementById('subcategoryDesc').value;
      await fetch('/api/settings/subcategories', {
        method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'include',
        body: JSON.stringify({ category_id, name, description: desc })
      });
      e.target.reset();
      loadSubcategories();
    };

    // --- SLA LEVELS CRUD ---
    async function loadSla() {
      const tbody = document.querySelector('#slaTable tbody');
      tbody.innerHTML = '<tr><td colspan="5">Loading...</td></tr>';
      try {
        const res = await fetch('/api/settings/sla', { credentials: 'include' });
        const slas = await res.json();
        tbody.innerHTML = '';
        slas.forEach(sla => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><input type="text" value="${sla.NAME}" data-id="${sla.SLA_LEVEL_ID}" class="edit-sla-name" style="border:none;background:transparent;width:100%" readonly /></td>
            <td><input type="text" value="${sla.DESCRIPTION || ''}" data-id="${sla.SLA_LEVEL_ID}" class="edit-sla-desc" style="border:none;background:transparent;width:100%" readonly /></td>
            <td><input type="number" value="${sla.RESPONSE_TIME_HOURS || ''}" data-id="${sla.SLA_LEVEL_ID}" class="edit-sla-response" style="border:none;background:transparent;width:100%" readonly /></td>
            <td><input type="number" value="${sla.RESOLUTION_TIME_HOURS || ''}" data-id="${sla.SLA_LEVEL_ID}" class="edit-sla-resolution" style="border:none;background:transparent;width:100%" readonly /></td>
            <td>
              <button class="action-btn edit" data-id="${sla.SLA_LEVEL_ID}">Edit</button>
              <button class="action-btn delete" data-id="${sla.SLA_LEVEL_ID}">Delete</button>
            </td>`;
          tbody.appendChild(tr);
        });
        // Edit
        tbody.querySelectorAll('.edit').forEach(btn => {
          btn.onclick = e => {
            const id = btn.dataset.id;
            const nameInput = tbody.querySelector(`.edit-sla-name[data-id='${id}']`);
            const descInput = tbody.querySelector(`.edit-sla-desc[data-id='${id}']`);
            const respInput = tbody.querySelector(`.edit-sla-response[data-id='${id}']`);
            const resInput = tbody.querySelector(`.edit-sla-resolution[data-id='${id}']`);
            nameInput.readOnly = descInput.readOnly = respInput.readOnly = resInput.readOnly = false;
            nameInput.style.background = descInput.style.background = respInput.style.background = resInput.style.background = '#f9f9f9';
            btn.textContent = 'Save';
            btn.classList.remove('edit');
            btn.classList.add('save');
            btn.onclick = async () => {
              await fetch(`/api/settings/sla/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({
                  name: nameInput.value,
                  description: descInput.value,
                  response_time_hours: respInput.value,
                  resolution_time_hours: resInput.value
                })
              });
              loadSla();
            };
          };
        });
        // Delete
        tbody.querySelectorAll('.delete').forEach(btn => {
          btn.onclick = async () => {
            if (confirm('Delete this SLA level?')) {
              await fetch(`/api/settings/sla/${btn.dataset.id}`, { method: 'DELETE', credentials: 'include' });
              loadSla();
            }
          };
        });
      } catch (err) {
        tbody.innerHTML = '<tr><td colspan="5">Failed to load SLA levels</td></tr>';
      }
    }
    document.getElementById('addSlaForm').onsubmit = async e => {
      e.preventDefault();
      const name = document.getElementById('slaName').value;
      const desc = document.getElementById('slaDesc').value;
      const response_time_hours = document.getElementById('slaResponse').value;
      const resolution_time_hours = document.getElementById('slaResolution').value;
      await fetch('/api/settings/sla', {
        method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'include',
        body: JSON.stringify({ name, description: desc, response_time_hours, resolution_time_hours })
      });
      e.target.reset();
      loadSla();
    };

    // --- ROLES CRUD ---
    async function loadRoles() {
      const tbody = document.querySelector('#rolesTable tbody');
      tbody.innerHTML = '<tr><td colspan="2">Loading...</td></tr>';
      try {
        const res = await fetch('/api/settings/roles', { credentials: 'include' });
        const roles = await res.json();
        console.log('Loaded roles:', roles);
        tbody.innerHTML = '';
        roles.forEach(role => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><input type="text" value="${role.ROLE_NAME}" data-id="${role.ROLE_ID}" class="edit-role-name" style="border:none;background:transparent;width:100%" readonly /></td>
            <td>
              <button class="action-btn edit" data-id="${role.ROLE_ID}">Edit</button>
              <button class="action-btn delete" data-id="${role.ROLE_ID}">Delete</button>
            </td>`;
          tbody.appendChild(tr);
        });
        // Edit
        tbody.querySelectorAll('.edit').forEach(btn => {
          btn.onclick = e => {
            const id = btn.dataset.id;
            const nameInput = tbody.querySelector(`.edit-role-name[data-id='${id}']`);
            nameInput.readOnly = false;
            nameInput.style.background = '#f9f9f9';
            btn.textContent = 'Save';
            btn.classList.remove('edit');
            btn.classList.add('save');
            btn.onclick = async () => {
              await fetch(`/api/settings/roles/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ role_name: nameInput.value })
              });
              loadRoles();
            };
          };
        });
        // Delete
        tbody.querySelectorAll('.delete').forEach(btn => {
          btn.onclick = async () => {
            if (confirm('Delete this role?')) {
              try {
                const response = await fetch(`/api/settings/roles/${btn.dataset.id}`, { method: 'DELETE', credentials: 'include' });
                const result = await response.json();
                
                if (!response.ok) {
                  alert('‚ùå ' + result.message);
                  return;
                }
                
                alert('‚úÖ ' + result.message);
                loadRoles();
              } catch (err) {
                console.error('Error deleting role:', err);
                alert('‚ùå Failed to delete role');
              }
            }
          };
        });
      } catch (err) {
        tbody.innerHTML = '<tr><td colspan="2">Failed to load roles</td></tr>';
      }
    }
    document.getElementById('addRoleForm').onsubmit = async e => {
      e.preventDefault();
      const role_name = document.getElementById('roleName').value;
      await fetch('/api/settings/roles', {
        method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'include',
        body: JSON.stringify({ role_name })
      });
      e.target.reset();
      loadRoles();
    };

    // Initial load
    loadCategories();
    loadSubcategories();
    loadSla();
    loadRoles();
  </script>
</body>
</html> 