<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Helpdesk | Admin Dashboard</title>
  <link rel="stylesheet" href="dashboard.css" />
</head>
<body>
  <div class="dashboard">
  <aside class="sidebar">
    <h2>Help Desk</h2>
    <ul>
      <li><a class="nav-link active" id="nav-tickets"><span>üìã</span> Tickets</a></li>
      <li><a href="templates.html" class="nav-link" id="nav-templates"><span>üìÑ</span> Templates</a></li>
      <li><a href="knowledgebase.html" class="nav-link" id="nav-kb"><span>üìö</span> Knowledgebase</a></li>
      <li><a href="categories.html" class="nav-link" id="nav-categories"><span>üìÇ</span> Categories</a></li>
      <li><a href="team.html" class="nav-link" id="nav-team"><span>üë•</span> Team</a></li>
      <li><a href="reports.html" class="nav-link" id="nav-reports"><span>üìä</span> Reports</a></li>
      <li><a href="admin_tools.html" class="nav-link" id="nav-tools"><span>üîß</span> Tools</a></li>
      <li><a href="settings.html" class="nav-link" id="nav-settings"><span>‚öôÔ∏è</span> Settings</a></li>
      <!-- Users link will be injected by JS for admins -->
    </ul>
  </aside>

  <main class="main-content">
    <header class="dashboard-header">
      <button class="btn create-ticket-btn">Create New Ticket</button>
      <div class="user-info" id="userName">üë§ Loading... ‚ñæ</div>
    </header>

    <section class="ticket-summary">
  <button class="filter-btn active" data-type="open">Open Tickets <span class="badge" id="open-count">0</span></button>
  <button class="filter-btn" data-type="assigned">Assigned<span class="badge" id="assigned-count">0</span></button>
  <button class="filter-btn due" data-type="due">Due Soon <span class="badge" id="due-count">0</span></button>
  <button class="filter-btn overdue" data-type="overdue">Overdue <span class="badge red" id="overdue-count">0</span></button>
  <button class="filter-btn" data-type="resolved">Resolved <span class="badge" id="resolved-count">0</span></button>
  <button class="filter-btn" data-type="closed">Closed <span class="badge" id="closed-count">0</span></button>
<button class="filter-btn" data-type="sla-nearing">SLA Nearing <span class="badge" id="slaNearingCount">0</span></button>
<button class="filter-btn" data-type="sla-breached">SLA Breached <span class="badge" id="slaBreachedCount">0</span></button>
</section>
    <section class="ticket-table" id="ticketTableSection">
      <table>
        <thead>
          <tr>
            <th>Tracking ID</th>
            <th>Updated</th>
            <th>Name</th>
            <th>Assigned Agent</th>
            <th>Subject</th>
            <th>Status</th>
            <th>Last Replier</th>
            <th>Due Date</th>
            <th>Priority</th>
            <th>Response Due</th>
            <th>Resolution Due</th>
            <th>Category</th>
            <th>Subcategory</th>
          </tr>
        </thead>
        <tbody id="ticketList">
        </tbody>
      </table>
    </section>
    <div id="attentionBox" class="attention-box">
      <strong>‚ö†Ô∏è Attention:</strong>
      <p>There are <span id="attentionslaBreached">0</span> ticket(s) with SLA breached</p>
      <p>There are <span id="attentionslaNearing">0</span> ticket(s) with SLA nearing deadline</p>
      <p>There are <span id="overdueCount">0</span> overdue ticket(s)</p>
      <p>There are <span id="dueSoonCount">0</span> ticket(s) due soon</p>
      <p>There are <span id="openCount">0</span> open ticket(s) that need attention</p>
    </div>
    <section class="create-ticket"id="createTicketSection" style="display: none;">
      <h2>Create New Ticket</h2>
      <form id="ticketForm">
      <input type="text" id="title" placeholder="Ticket Title" required />
      <textarea id="description" rows="4" placeholder="Describe your issue..." required></textarea>
      <select id="category_id" required>
        <option value="">Select Category</option>
      </select>
      <select id="subcategory_id" required>
        <option value="">Select Subcategory</option>
      </select>
      <select id="priority_id" required>
        <option value="">Select Priority</option>
        <option value="1">Low</option>
        <option value="2">Medium</option>
        <option value="3">High</option>
        <option value="4">Critical</option>
      </select>
      <select id="sla_id" required>
        <option value="">Select SLA Level</option>
      </select>
      <div id="slaDetails" style="font-size: 13px; margin-top: 6px; color: #555;"></div>
      <button type="submit">Submit Ticket</button>
      <button id="backToTicketsBtn" style="margin-bottom: 15px;">‚Üê Back to My Tickets</button>
      </form>
    </section>
  </main>
</div>

<script>
    document.querySelector('.create-ticket-btn').addEventListener('click', () => {
    document.getElementById('ticketTableSection').style.display = 'none';
    document.getElementById('createTicketSection').style.display = 'block';
  });
  document.getElementById('backToTicketsBtn').addEventListener('click', () => {
    document.getElementById('createTicketSection').style.display = 'none';
    document.getElementById('ticketTableSection').style.display = 'block';
  });
    let userId = null;  // global userId
      window.addEventListener('DOMContentLoaded', async () => {
    try {
      const response = await fetch('http://localhost:3000/api/me', {
        credentials: 'include'
      });
    const data = await response.json();

      if (response.ok) {
  userId = data.userId;
  document.getElementById("userName").textContent = `üë§ ${data.username} ‚ñæ`;
  // Set Tools link based on role
  const navTools = document.getElementById('nav-tools');
  if (data.role_id === 1) navTools.href = 'admin_tools.html';
  else if (data.role_id === 2) navTools.href = 'agent_tools.html';
  else navTools.href = 'customer_tools.html';
  // Inject Users link if admin
  if (data.role_id === 1) {
    const usersLi = document.createElement('li');
    usersLi.innerHTML = '<a href="admin_users.html" class="nav-link" id="nav-users"><span>üë§</span> Users</a>';
    document.querySelector('.sidebar ul').appendChild(usersLi);
  }
  setTimeout(() => loadAllTickets(), 0);
} else {
        alert('Not logged in. Redirecting to login page.');
        window.location.href = 'signin.html';
      }
    } catch (err) {
      console.error('Error fetching user info:', err);
    }
    console.log("Logged-in user ID:", userId);
  });
  const form = document.getElementById("ticketForm");
async function loadFormDropdowns() {
  try {
    // Fetch categories
    const catRes = await fetch("http://localhost:3000/api/categories", { credentials: "include" });
    const categories = await catRes.json();
    const categorySelect = document.getElementById("category_id");
    categories.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c.CATEGORY_ID;
      opt.textContent = c.NAME;
      categorySelect.appendChild(opt);
    });

    // Fetch subcategories
    const subcatRes = await fetch("http://localhost:3000/api/subcategories", { credentials: "include" });
    const subcategories = await subcatRes.json();

    const subcategorySelect = document.getElementById("subcategory_id");

    // Filter subcategories based on category selection
    categorySelect.addEventListener("change", () => {
      const selectedCat = categorySelect.value;
      subcategorySelect.innerHTML = `<option value="">Select Subcategory</option>`;
      subcategories.filter(sc => sc.CATEGORY_ID == selectedCat).forEach(sc => {
        const opt = document.createElement("option");
        opt.value = sc.SUBCATEGORY_ID;
        opt.textContent = sc.NAME;
        subcategorySelect.appendChild(opt);
      });
    });

    // Fetch SLA levels
    const slaRes = await fetch("http://localhost:3000/api/sla-levels", { credentials: "include" });
    const slaLevels = await slaRes.json();
    const slaSelect = document.getElementById("sla_id");
    const slaDetailsDiv = document.getElementById("slaDetails");

    slaLevels.forEach(sla => {
      const opt = document.createElement("option");
      opt.value = sla.SLA_LEVEL_ID;
      opt.textContent = sla.NAME;
      opt.dataset.response = sla.RESPONSE_TIME_HOURS;
      opt.dataset.resolution = sla.RESOLUTION_TIME_HOURS;
      slaSelect.appendChild(opt);
    });

    slaSelect.addEventListener("change", () => {
      const selected = slaSelect.selectedOptions[0];
      if (selected && selected.value) {
        slaDetailsDiv.innerHTML = `Response Due: <strong>${selected.dataset.response} hrs</strong>, Resolution Due: <strong>${selected.dataset.resolution} hrs</strong>`;
      } else {
        slaDetailsDiv.innerHTML = "";
      }
    });
  } catch (err) {
    console.error("Error loading form data:", err);
  }
}
// Call this on page load
window.addEventListener('DOMContentLoaded', () => {
  loadFormDropdowns();
});

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
const payload = {
  title: document.getElementById("title").value,
  description: document.getElementById("description").value,
  category_id: document.getElementById("category_id").value,
  subcategory_id: document.getElementById("subcategory_id").value,
  priority_id: document.getElementById("priority_id").value,
  sla_id: document.getElementById("sla_id").value
};

    const res = await fetch("http://localhost:3000/tickets", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify(payload)
    });

    if (res.ok) {
      alert("Ticket created successfully!");
      form.reset();
      loadTickets(userId);
      document.getElementById("createTicketSection").style.display = "none";
      document.getElementById("ticketTableSection").style.display = "block";
    } else {
      alert("Error creating ticket.");
    }
  });
const ticketList = document.getElementById("ticketList");
let allTickets = [];
async function loadAllTickets() {
  try {
    const res = await fetch(`http://localhost:3000/api/admin/all-tickets`, {
      method: "GET",
      headers: { "Content-Type": "application/json" },
      credentials: "include"
    });

    if (!res.ok) {
      console.error("‚ùå Failed to fetch tickets:", res.status);
      alert("Error fetching tickets.");
      return;
    }

    const data = await res.json();

    if (!Array.isArray(data)) {
      console.error("‚ùå Invalid response format. Expected an array but got:", data);
      alert("Invalid ticket data.");
      return;
    }

    allTickets = data;
    console.log("‚úÖ Loaded tickets:", allTickets);
    renderTickets("open");

  } catch (err) {
    console.error("üî• Error fetching tickets:", err);
  }
}


function renderTickets(filterType) {
  ticketList.innerHTML = "";
  const now = new Date();
  let count = {
    open: 0,
    assigned: 0,
    due: 0,
    overdue: 0,
    resolved: 0,
    closed: 0
  };
  const todayOnly = new Date(now.getFullYear(), now.getMonth(), now.getDate());
let agentSlaBreached = 0;
let agentSlaNearing = 0;
allTickets.forEach(ticket => {
  if (ticket.RESPONSE_DUE && new Date(ticket.RESPONSE_DUE) < now && ticket.STATUS_ID !== 3 && ticket.STATUS_ID !== 4) {
    agentSlaBreached++;
  }else if (ticket.RESPONSE_DUE &&
    new Date(ticket.RESPONSE_DUE) - now <= 2 * 60 * 60 * 1000 &&
    new Date(ticket.RESPONSE_DUE) > now &&
    ticket.STATUS_ID !== 3 && ticket.STATUS_ID !== 4) {
      agentSlaNearing++;
}})
  const filtered = allTickets.filter(ticket => {
    let isDueValid = false;
    let diffDays = null;
    if (ticket.DUE_DATE && ticket.STATUS_ID !== 3 && ticket.STATUS_ID !== 4) {
      const dueDate = new Date(ticket.DUE_DATE);
      if (!isNaN(dueDate)) {
        isDueValid = true;
        const dueDateOnly = new Date(dueDate.getFullYear(), dueDate.getMonth(), dueDate.getDate());
        diffDays = Math.floor((dueDateOnly - todayOnly) / (1000 * 60 * 60 * 24));
        if (diffDays < 7 && diffDays >= 0) count.due++;
        else if (diffDays < 0) count.overdue++;
      }
    }
    if (ticket.STATUS_ID === 1) count.open++;
    if (ticket.ASSIGNED_TO != null) count.assigned++;
    if (ticket.STATUS_ID === 3) count.resolved++;
    if (ticket.STATUS_ID === 4) count.closed++;

    switch (filterType) {
      case "open": return ticket.STATUS_ID === 1;
      case "assigned": return ticket.ASSIGNED_TO != null;
      case "due": return ticket.STATUS_ID !==3 && ticket.STATUS_ID !==4 && isDueValid && diffDays <= 7 && diffDays >= 0;
      case "overdue": return ticket.STATUS_ID !==3 && ticket.STATUS_ID !==4 && isDueValid && diffDays < 0;
      case "resolved": return ticket.STATUS_ID === 3;
      case "closed": return ticket.STATUS_ID === 4;
      case "sla-nearing":
        return ticket.STATUS_ID !==3 && ticket.STATUS_ID !==4 && ticket.RESPONSE_DUE && new Date(ticket.RESPONSE_DUE) - now <= 2 * 60 * 60 * 1000 && new Date(ticket.RESPONSE_DUE) > now;
      case "sla-breached":
        return ticket.STATUS_ID !==3 && ticket.STATUS_ID !==4 && ticket.RESPONSE_DUE && new Date(ticket.RESPONSE_DUE) < now;
      default: return true;
    }
  });

  if (filtered.length === 0) {
    ticketList.innerHTML = "<tr><td colspan='13'>No tickets in this category.</td></tr>";
    return;
  }else {
  filtered.forEach(ticket => {
    const row = document.createElement("tr");
          const now = new Date();
    const dueDate = ticket.DUE_DATE ? new Date(ticket.DUE_DATE) : null;
let diffDays = null;

if (dueDate && !isNaN(dueDate)) {
  const dueDateOnly = new Date(dueDate.getFullYear(), dueDate.getMonth(), dueDate.getDate());
  diffDays = Math.floor((dueDateOnly - todayOnly) / (1000 * 60 * 60 * 24));

  if (diffDays < 0 && ticket.STATUS_ID !== 3 && ticket.STATUS_ID !== 4) {
    row.classList.add("overdue-row");
  } else if (diffDays <= 7 && diffDays >= 0 && ticket.STATUS_ID !== 3 && ticket.STATUS_ID !== 4) {
    row.classList.add("due-soon-row");
  }
}   
if (ticket.RESPONSE_DUE && new Date(ticket.RESPONSE_DUE) < now && ticket.STATUS_ID !== 3 && ticket.STATUS_ID !== 4) {
    row.classList.add("sla-breached");
  }else if (ticket.RESPONSE_DUE &&
    new Date(ticket.RESPONSE_DUE) - now <= 2 * 60 * 60 * 1000 &&
    new Date(ticket.RESPONSE_DUE) > now &&
    ticket.STATUS_ID !== 3 && ticket.STATUS_ID !== 4) {
        row.classList.add("sla-nearing");
}
    let priorityClass = "";
    switch (ticket.PRIORITY_ID) {
      case 1: priorityClass = "priority-low"; break;
      case 2: priorityClass = "priority-medium"; break;
      case 3: priorityClass = "priority-high"; break;
      case 4: priorityClass = "priority-critical"; break;
    }

    row.innerHTML = `
      <td>${ticket.TICKET_ID}</td>
      <td>${ticket.UPDATED_AT || '-'}</td>
      <td>${ticket.NAME || 'User'}</td>
      <td>${ticket.AGENT_NAME || '-'}</td>
      <td>${ticket.TITLE}</td>
      <td>${ticket.STATUS}</td>
      <td>${ticket.LAST_REPLIER || '-'}</td>
      <td>${ticket.DUE_DATE ? new Date(ticket.DUE_DATE).toLocaleString() : '-'}</td>
      <td class="${priorityClass}">${['Low', 'Medium', 'High', 'Critical'][ticket.PRIORITY_ID - 1]}</td>
      <td>${ticket.RESPONSE_DUE ? new Date(ticket.RESPONSE_DUE).toLocaleString() : '-'}</td>
      <td>${ticket.RESOLUTION_DUE ? new Date(ticket.RESOLUTION_DUE).toLocaleString() : '-'}</td>
      <td>${ticket.CATEGORY_NAME || '-'}</td>
      <td>${ticket.SUBCATEGORY_NAME || '-'}</td>
      `;
    row.style.cursor = "pointer";
    row.addEventListener("click", () => {
      window.location.href = `ticketview.html?ticketId=${ticket.TICKET_ID}`;
    });
    ticketList.appendChild(row);
  });
  }

  // Update count badges
  document.getElementById("open-count").innerText = count.open;
  document.getElementById("assigned-count").innerText = count.assigned;
  document.getElementById("due-count").innerText = count.due;
  document.getElementById("overdue-count").innerText = count.overdue;
  document.getElementById("resolved-count").innerText = count.resolved;
  document.getElementById("closed-count").innerText = count.closed;
  document.getElementById("slaBreachedCount").textContent = agentSlaBreached;
  document.getElementById("slaNearingCount").textContent = agentSlaNearing;


document.getElementById("overdueCount").textContent = count.overdue;
document.getElementById("dueSoonCount").textContent = count.due;
document.getElementById("openCount").textContent = count.open;
document.getElementById("attentionslaBreached").textContent = agentSlaBreached;
document.getElementById("attentionslaNearing").textContent = agentSlaNearing;
const hasAttention = count.overdue > 0 || count.due > 0 || count.open > 0 || agentSlaBreached > 0 || agentSlaNearing > 0;
document.getElementById("attentionBox").style.display = hasAttention ? "block" : "none";
}

    document.getElementById('nav-tickets').classList.add('active');
    document.querySelectorAll(".filter-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".filter-btn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");

    const filterType = btn.dataset.type || btn.innerText.toLowerCase().split(" ")[0];
    renderTickets(filterType);
  });
});

  </script>
</body>
</html>
